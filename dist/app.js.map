{"version":3,"sources":["../src/radicchio.js"],"names":[],"mappings":"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","file":"app.js","sourcesContent":["// Radicchio imports\nrequire('babel-core/register');\nimport Redis from 'ioredis';\nimport fs from 'fs';\nimport Promise from 'bluebird';\nimport ShortId from 'shortid';\nimport eventEmitter from 'event-emitter';\nimport _ from 'lodash';\n\n// Radicchio constants\nconst redis = new Redis();\nconst sub = new Redis();\nconst emitter = eventEmitter({});\nconst radicchio = {};\nconst setTTLSuffix = '-ttl-set';\nconst setDataSuffix = '-data-set';\nconst suspendedSuffix = '-suspended';\nconst resumedSuffix = '-resumed';\n\n/**\n* Loads a lua file\n* @param {String} fileName - the lua file name to load from the lua folder\n* @returns {String} - the loaded file contents\n*/\nfunction loadLuaFile(fileName) {\n  const luaDirectory = __dirname + '/../src/lua/';\n  return fs.readFileSync(luaDirectory + fileName, 'utf8');\n}\n\n/**\n* Update loop that runs once a second and targets redis keys to ensure expiration\n*/\nfunction update() {\n  radicchio.getAllTimesLeft();\n  radicchio.getDataFromAllTimers();\n}\n\n/**\n* Sets up event-emitter events to react to Redis Pub/Sub\n* Current supported internal events: deleted, expired, suspended, and resumed\n* @param {String} event - the supported event name to listen for\n* @param {Function} - the callback function passed to event-emitter\n*/\nradicchio.on = function (event, callback) {\n  emitter.on(event, callback);\n};\n\n/**\n* Setup initial synchronous settings, events, commands, and files for Radicchio\n* @returns {Promise<Boolean>} - Resolves to true when initialized\n*/\nradicchio.init = function () {\n  const EVENT_DELETED = '__keyevent@0__:del';\n  const EVENT_EXPIRED = '__keyevent@0__:expired';\n  const EVENT_EXPIRE = '__keyevent@0__:expire';\n\n  radicchio.globalSetId = ShortId.generate();\n\n  radicchio.timerSetId = radicchio.globalSetId + setTTLSuffix;\n  radicchio.dataSetId = radicchio.globalSetId + setDataSuffix;\n\n  return new Promise(function (resolve) {\n    // Load lua files\n    const startFile = loadLuaFile('start.lua');\n    const deleteFile = loadLuaFile('delete.lua');\n    const getSetKeysFile = loadLuaFile('getSetKeys.lua');\n    const getTimeLeftFile = loadLuaFile('getTimeLeft.lua');\n    const suspendFile = loadLuaFile('suspend.lua');\n    const resumeFile = loadLuaFile('resume.lua');\n    const getDataFile = loadLuaFile('getTimerData.lua');\n    const deleteFromSetsFile = loadLuaFile('deleteFromSets.lua');\n\n    // Redis Pub/Sub config settings\n    redis.config('SET', 'notify-keyspace-events', 'KEA');\n\n    // Redis custom defined commands\n    redis.defineCommand('startTimer', {\n      numberOfKeys: 3,\n      lua: startFile,\n    });\n\n    redis.defineCommand('deleteTimer', {\n      numberOfKeys: 2,\n      lua: deleteFile,\n    });\n\n    redis.defineCommand('getSetKeys', {\n      numberOfKeys: 1,\n      lua: getSetKeysFile,\n    });\n\n    redis.defineCommand('getTimeLeft', {\n      numberOfKeys: 1,\n      lua: getTimeLeftFile,\n    });\n\n    redis.defineCommand('suspendTimer', {\n      numberOfKeys: 2,\n      lua: suspendFile,\n    });\n\n    redis.defineCommand('resumeTimer', {\n      numberOfKeys: 2,\n      lua: resumeFile,\n    });\n\n    redis.defineCommand('getTimerData', {\n      numberOfKeys: 1,\n      lua: getDataFile,\n    });\n\n    redis.defineCommand('deleteFromSets', {\n      numberOfKeys: 2,\n      lua: deleteFromSetsFile,\n    });\n\n    // Event handler for Redis Pub/Sub events with the subscribing Redis client\n    sub.on('message', function (channel, message) {\n      if (channel === EVENT_DELETED) {\n        if (message.indexOf(suspendedSuffix) >= 0) {\n          emitter.emit('suspended', message);\n        }\n        else if (message.indexOf(setDataSuffix) >= 0) {\n          radicchio.dataSetId = null;\n        }\n        else if (message.indexOf(setTTLSuffix) >= 0) {\n          radicchio.timerSetId = null;\n        }\n        else if (message.indexOf(setTTLSuffix) === -1) {\n          emitter.emit('deleted', message);\n        }\n\n        if (radicchio.timerSetId === null && radicchio.dataSetId === null) {\n          radicchio.globalSetId = ShortId.generate();\n          radicchio.timerSetId = radicchio.globalSetId + setTTLSuffix;\n          radicchio.dataSetId = radicchio.globalSetId + setDataSuffix;\n        }\n      }\n      else if (channel === EVENT_EXPIRED && message.indexOf(setTTLSuffix) === -1) {\n        redis.deleteFromSets(radicchio.timerSetId, radicchio.dataSetId, message, function () {});\n\n        radicchio.getTimerData(message)\n        .then((timerObj) => {\n          emitter.emit('expired', timerObj);\n        });\n      }\n      else if (channel === EVENT_EXPIRE && message.indexOf(resumedSuffix) >= 0) {\n        emitter.emit('resumed', message);\n      }\n    });\n\n    // Subscribe to the Redis Pub/Sub events with the subscribing Redis client\n    sub.subscribe(EVENT_DELETED, EVENT_EXPIRED, EVENT_EXPIRE);\n\n    // Setup the update function\n    setInterval(update, 1000);\n\n    resolve(true);\n  });\n};\n\n/**\n* Generates an id for a set and a timer using shortid\n* Tracks the timer key in a Redis set and starts an expire on the timer key\n* @param {String} timeInMS - The timer length in milliseconds\n* @param {Object} data - data object to be associated with the timer\n* @returns {Promise<String|Error>} - Resolves to the started timer id\n*/\nradicchio.startTimer = function (timeInMS, data) {\n  if (data === undefined || data === null) {\n    data = {};\n  }\n\n  return new Promise(function (resolve, reject) {\n    try {\n      const timerId = ShortId.generate();\n      const dataStringified = JSON.stringify(data);\n\n      redis.startTimer(radicchio.timerSetId, timerId, radicchio.dataSetId, timeInMS, dataStringified, '', function (err, result) {\n        if (err) {\n          reject(err);\n        }\n        else if (result.toLowerCase() === 'ok') {\n          resolve(timerId);\n        }\n      });\n    }\n    catch (e) {\n      reject(e);\n    }\n  });\n};\n\n/**\n* Suspends a timer by updating the TTL in the global Redis set and deleting the timer\n* @param {String} timerId - The timer id to be suspended\n* @returns {Promise<Boolean|Error>} - Resolves to true if suspended successfully\n*/\nradicchio.suspendTimer = function (timerId) {\n  return new Promise(function (resolve, reject) {\n    try {\n      redis.suspendTimer(radicchio.timerSetId, timerId, timerId + suspendedSuffix, '', function (err, result) {\n        if (err) {\n          reject(err);\n        }\n        else if (result === 1) {\n          resolve(true);\n        }\n      });\n    }\n    catch (e) {\n      reject(e);\n    }\n  });\n};\n\n/**\n* Starts a new timer with the remaining TTL in milliseconds pulled from the global Redis set\n* @param {String} timerId - The timer id to be resumed\n* @returns {Promise<Boolean|Error>} - Resolves to true if resumed successfully\n*/\nradicchio.resumeTimer = function (timerId) {\n  return new Promise(function (resolve, reject) {\n    try {\n      redis.resumeTimer(radicchio.timerSetId, timerId, timerId + resumedSuffix, '', function (err, result) {\n        if (err) {\n          reject(err);\n        }\n        else if (result.toLowerCase() === 'ok') {\n          resolve(true);\n        }\n      });\n    }\n    catch (e) {\n      reject(e);\n    }\n  });\n};\n\n/**\n* Deletes a timer from Redis and the global Redis set\n* @param {String} timerId - The timer id to be deleted\n* @returns {Promise<Object|Error>} - Resolves to an object containing associated timer data\n*/\nradicchio.deleteTimer = function (timerId) {\n  return new Promise(function (resolve, reject) {\n    try {\n      redis.deleteTimer(radicchio.timerSetId, radicchio.dataSetId, timerId, '', function (err, result) {\n        if (err) {\n          reject(err);\n        }\n        else if (result !== 'nil') {\n          const data = JSON.parse(result);\n          resolve(data);\n        }\n        else {\n          reject(null);\n        }\n      });\n    }\n    catch (e) {\n      reject(e);\n    }\n  });\n};\n\n/**\n* Gets the TTL (time to live) in milliseconds on a timer in Redis\n* @param {String} timerId - The timer id get the time left on\n* @returns {Promise<Object(String, Number)|Error>} - Resolves to an object with the timer id and time left\n*/\nradicchio.getTimeLeft = function (timerId) {\n  return new Promise(function (resolve, reject) {\n    try {\n      redis.getTimeLeft(timerId, '', function (err, timeLeft) {\n        if (err) {\n          reject(err);\n        }\n        else if (timeLeft >= 0) {\n          const timerObj = {\n            timerId,\n            timeLeft,\n          };\n          resolve(timerObj);\n        }\n        else if (timeLeft < 0) {\n          resolve(null);\n        }\n      });\n    }\n    catch (e) {\n      reject(e);\n    }\n  });\n};\n\n/**\n* Gets the TTL (time to live) in milliseconds on all timers in the global Redis set\n* Filters out any timers that have no time left or have expired\n* @returns {Promise<Array(Object(String, Number))}>|Error>} - Resolves to an array of objects with a timer id and time left\n*/\nradicchio.getAllTimesLeft = function () {\n  const promises = [];\n\n  return new Promise(function (resolve, reject) {\n    try {\n      redis.getSetKeys(radicchio.timerSetId, '', function (err, result) {\n        if (err) {\n          reject(err);\n        }\n        else {\n          _.map(result, function (timerId) {\n            promises.push(radicchio.getTimeLeft(timerId));\n          });\n\n          Promise.all(promises)\n          .then((timerObjs) => {\n            const filtered = _.filter(timerObjs, function (timerObj) {\n              return timerObj !== null && timerObj.timeLeft > 0;\n            });\n\n            resolve(filtered);\n          });\n        }\n      });\n    }\n    catch (e) {\n      reject(e);\n    }\n  });\n};\n\n/**\n* Gets the data associated with a timer\n* @param {String} timerId - The timer id to get the associated data for\n* @returns {Promise<Object(String, Object)|Error>} - Resolves to an object with the timer id and associated timer data\n*/\nradicchio.getTimerData = function (timerId) {\n  return new Promise(function (resolve, reject) {\n    try {\n      redis.getTimerData(radicchio.dataSetId, timerId, function (err, result) {\n        if (err) {\n          reject(err);\n        }\n        else {\n          if (result === 'nil') {\n            reject(null);\n          }\n          else {\n            const data = JSON.parse(result);\n            const timerObj = {\n              timerId,\n              data,\n            };\n\n            resolve(timerObj);\n          }\n        }\n      });\n    }\n    catch (e) {\n      reject(e);\n    }\n  });\n};\n\n/**\n* Get the data from all active timers (including suspended timers)\n* @returns {Promise<Array<Object(String, Object)>|Error>} - Resolves to an array of objects with a timer id and data object\n*/\nradicchio.getDataFromAllTimers = function () {\n  const promises = [];\n\n  return new Promise(function (resolve, reject) {\n    try {\n      redis.getSetKeys(radicchio.dataSetId, '', function (err, result) {\n        if (err) {\n          reject(err);\n        }\n        else {\n          _.map(result, function (timerId) {\n            promises.push(radicchio.getTimerData(timerId));\n          });\n\n          Promise.all(promises)\n          .then((timerDataObjs) => {\n            resolve(timerDataObjs);\n          });\n        }\n      });\n    }\n    catch (e) {\n      reject(e);\n    }\n  });\n};\n\nmodule.exports = radicchio;\n"]}